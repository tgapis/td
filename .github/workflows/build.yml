name: Build TDLib (ARM64, clang)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git \
            cmake \
            gperf \
            zlib1g-dev \
            libssl-dev \
            clang \
            libc++-dev \
            libc++abi-dev \
            make

      - name: Clone TDLib
        run: |
          git clone --depth 1 https://github.com/tdlib/td.git
          ls -la td

      - name: Configure TDLib
        run: |
          cd td
          mkdir build
          cd build
          CC=clang CXX=clang++ \
          CXXFLAGS="-stdlib=libc++" \
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DTD_ENABLE_JNI=OFF \
            -DTD_ENABLE_DOTNET=OFF \
            -DTD_ENABLE_LTO=ON

      - name: Build tdjson
        run: |
          cd td/build
          cmake --build . --target tdjson -- -j$(nproc)

      - name: Collect libtdjson.so
        run: |
          mkdir -p output
          find td/build -name "libtdjson.so" -exec cp {} output/ \;

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-arm64
          path: output/libtdjson.so
